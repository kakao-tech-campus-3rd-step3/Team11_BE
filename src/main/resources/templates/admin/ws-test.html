<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket(STOMP) Test - MoMeet</title>
    <script src="https://unpkg.com/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://unpkg.com/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 20px; }
        h1 { font-size: 18px; margin: 0 0 12px; }
        fieldset { border: 1px solid #ddd; padding: 12px; margin-bottom: 16px; }
        legend { padding: 0 6px; color: #555; }
        label { display: inline-block; width: 140px; color: #333; }
        input[type="text"], input[type="url"] { width: 420px; padding: 6px; }
        select { padding: 6px; }
        button { padding: 6px 10px; margin-right: 6px; }
        textarea { width: 100%; height: 240px; padding: 8px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        .row { margin: 6px 0; }
        .chip { display: inline-block; padding: 2px 6px; font-size: 12px; background: #eef; color: #224; border-radius: 4px; margin-left: 8px; }
        .status { margin-left: 8px; font-weight: 600; }
        .danger { color: #b00020; }
        .success { color: #1b5e20; }
        .muted { color: #666; }
        .hint { font-size: 12px; color: #666; margin-top: 4px; }
    </style>
    <!--
      사용 방법
      1) Base URL을 백엔드 주소로 설정 (예: http://localhost:8080)
      2) 미팅방 ID(UUID)를 입력
      3) Connect를 누르면 자동으로 /topic/meetups/{id}/messages, /actions 구독
      4) 메시지 입력 후 Send

      인증 주의사항
      - 서버는 핸드셰이크 단계에서 Cookie 또는 Authorization 헤더로 인증합니다.
      - 이 테스트 페이지를 백엔드와 동일 오리진(예: http://localhost:8080/docs/ws-test.html)에서 열면
        쿠키 기반 인증이 가장 잘 동작합니다.
    -->
</head>
<body>
    <h1>WebSocket(STOMP) Test <span id="connStatus" class="status muted">DISCONNECTED</span></h1>

    <fieldset>
        <legend>Auth</legend>
        <div class="row">
            <label for="loginEmail">Email</label>
            <input id="loginEmail" type="text" placeholder="user@example.com" />
        </div>
        <div class="row">
            <label for="loginPassword">Password</label>
            <input id="loginPassword" type="password" placeholder="********" />
        </div>
        <div class="row">
            <button id="btnLogin">Login</button>
            <span class="hint">성공 시 쿠키에 토큰이 설정됩니다.</span>
        </div>
    </fieldset>

    <fieldset>
        <legend>Connection</legend>
        <div class="row">
            <label for="baseUrl">Base URL</label>
            <input id="baseUrl" type="url" placeholder="http://localhost:8080" />
        </div>
        <div class="row">
            <label for="meetupId">Meetup ID (UUID)</label>
            <input id="meetupId" type="text" placeholder="00000000-0000-0000-0000-000000000000" />
        </div>
        <div class="row">
            <button id="btnConnect">Connect</button>
            <button id="btnDisconnect">Disconnect</button>
            <span class="chip">Endpoint: /ws/chat</span>
            <span class="chip">Send: /app/meetups/{id}/messages</span>
            <span class="chip">Sub: /topic/meetups/{id}/messages, /actions</span>
        </div>
        <div class="hint">가능하면 이 페이지를 백엔드와 같은 오리진에서 제공하세요: /docs/ws-test.html</div>
    </fieldset>

    <fieldset>
        <legend>Publish</legend>
        <div class="row">
            <label for="msgType">Type</label>
            <select id="msgType">
                <option value="TEXT" selected>TEXT</option>
                <option value="IMAGE">IMAGE</option>
                <option value="SYSTEM">SYSTEM</option>
            </select>
        </div>
        <div class="row">
            <label for="msgContent">Content</label>
            <input id="msgContent" type="text" placeholder="메시지 내용을 입력하세요" />
        </div>
        <div class="row">
            <button id="btnSend">Send</button>
        </div>
    </fieldset>

    <fieldset>
        <legend>Logs</legend>
        <textarea id="logs" readonly></textarea>
    </fieldset>

    <script>
        let stompClient = null;
        let subscriptions = [];

        function byId(id) { return document.getElementById(id); }

        function log(message) {
            const el = byId('logs');
            const now = new Date().toISOString();
            el.value += `[${now}] ${message}\n`;
            el.scrollTop = el.scrollHeight;
        }

        function setStatus(connected) {
            const s = byId('connStatus');
            if (connected) {
                s.textContent = 'CONNECTED';
                s.className = 'status success';
            } else {
                s.textContent = 'DISCONNECTED';
                s.className = 'status muted';
            }
        }

        function getBaseUrl() {
            const v = byId('baseUrl').value.trim();
            return v || window.location.origin;
        }

        function getMeetupId() {
            return byId('meetupId').value.trim();
        }

        async function login() {
            const baseUrl = getBaseUrl();
            const email = byId('loginEmail').value.trim();
            const password = byId('loginPassword').value;
            if (!baseUrl) { alert('Base URL을 입력하세요.'); return; }
            if (!email || !password) { alert('이메일/비밀번호를 입력하세요.'); return; }

            const url = baseUrl.replace(/\/$/, '') + '/api/auth/login';
            log(`POST ${url}`);
            try {
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password }),
                    credentials: 'include'
                });

                const text = await res.text();
                let data = null;
                try { data = text ? JSON.parse(text) : null; } catch (_) {}
                if (!res.ok) {
                    log(`Login failed (${res.status}): ${text || res.statusText}`);
                    alert('로그인 실패');
                    return;
                }
                log('Login success. Cookies set.');
                if (data) {
                    const masked = {
                        accessToken: data.accessToken ? '***' : null,
                        refreshToken: data.refreshToken ? '***' : null
                    };
                    log(`TokenResponse: ${JSON.stringify(masked)}`);
                    localStorage.setItem('accessToken', data.accessToken);
                    localStorage.setItem('refreshToken', data.refreshToken);
                }
                await setSelfMeetupId();
            } catch (e) {
                log(`Login error: ${e}`);
                alert('로그인 중 오류가 발생했습니다.');
            }
        }

        async function setSelfMeetupId() {
            log('setSelfMeetupId');
            const baseUrl = getBaseUrl();
            const get_self_meetup_url = baseUrl.replace(/\/$/, '') + '/api/meetups/me';
            const accessToken = localStorage.getItem('accessToken');
            try {
                const res = await fetch(get_self_meetup_url, {
                    method: 'GET',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': accessToken ? `Bearer ${accessToken}` : ''
                    }
                });
                if (!res.ok) {
                    const errorText = await res.text();
                    log(`Meetup fetch failed (${res.status}): ${errorText}`);
                    alert(`미팅방 조회 실패: ${res.status} ${errorText}`);
                    return;
                }
                const self_meetup = await res.json();
                byId('meetupId').value = self_meetup.id;
                log(`Self meetup ID set: ${self_meetup.id}`);
            } catch (e) {
                log(`setSelfMeetupId error: ${e}`);
                alert('미팅방 ID 조회 중 오류가 발생했습니다.');
            }
        }

        async function getWsUpgradeToken() {
            const baseUrl = getBaseUrl();
            const url = baseUrl.replace(/\/$/, '') + '/api/auth/ws-upgrade'
            const accessToken = localStorage.getItem('accessToken');
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': accessToken ? `Bearer ${accessToken}` : ''
                    }
                });
                if (res.ok) {
                    return res.text();
                }
            } catch (e) {
                log(`getWsUpgradeToken error: ${e}`);
            }
            return null;
        }

        async function connect() {
            const baseUrl = getBaseUrl();
            const meetupId = getMeetupId();
            if (!baseUrl) {
                alert('Base URL을 입력하세요.');
                return;
            }
            if (!meetupId) {
                alert('Meetup ID를 입력하세요.');
                return;
            }

            if (stompClient && stompClient.connected) {
                log('이미 연결되어 있습니다.');
                return;
            }

            const wsToken = await getWsUpgradeToken();
            const authValue = localStorage.getItem('accessToken') ? `Bearer ${localStorage.getItem('accessToken')}` : '';

            const socketUrl = baseUrl.replace(/\/$/, '') + `/ws/chat?token=${encodeURIComponent(wsToken || '')}`;
            log(`Connecting to ${socketUrl} ...`);

            const socket = new SockJS(socketUrl);
            stompClient = Stomp.over(socket);
            stompClient.heartbeat.outgoing = 20000; // 클라이언트 -> 서버
            stompClient.heartbeat.incoming = 20000;
            // 로그 과다 방지
            stompClient.debug = function () {
            };

            stompClient.connect({
                Authorization: authValue
            }, function onConnect() {
                setStatus(true);
                log('STOMP connected');

                // 구독 설정
                const msgDest = `/topic/meetups/${meetupId}/messages`;
                const actDest = `/topic/meetups/${meetupId}/actions`;
                const errorDest = `/user/queue/errors`;

                // 에러 구독 추가
                subscriptions.push(stompClient.subscribe(
                    errorDest,
                    (frame) => {
                    log(`[ERROR] ${frame.body}`);
                }));
                // 액션 구독 추가
                subscriptions.push(
                    stompClient.subscribe(
                        actDest,
                        (frame) => {log(`[ACTION] ${frame.body}`);},
                        { Authorization : authValue }
                    ));
                // 메시지 구독 추가
                subscriptions.push(
                    stompClient.subscribe(
                        msgDest,
                        (frame) => {log(`[MESSAGE] ${frame.body}`);},
                        { Authorization : authValue }
                    ));

                log(`Subscribed: ${msgDest}, ${actDest}, ${errorDest}`);
            }, function onError(err) {
                setStatus(false);
                log(`Connection error: ${err && err.body ? err.body : err}`);
            });
        }

        function disconnect() {
            if (stompClient) {
                try {
                    subscriptions.forEach(s => { try { s.unsubscribe(); } catch(_) {} });
                    subscriptions = [];
                    stompClient.disconnect(() => {
                        log('Disconnected');
                        setStatus(false);
                    });
                } catch (e) {
                    log(`Disconnect error: ${e}`);
                } finally {
                    stompClient = null;
                }
            } else {
                setStatus(false);
            }
        }

        function sendMessage() {
            const authValue = localStorage.getItem('accessToken') ? `Bearer ${localStorage.getItem('accessToken')}` : '';
            if (!stompClient || !stompClient.connected) {
                alert('먼저 Connect 하세요.');
                return;
            }
            const meetupId = getMeetupId();
            const type = byId('msgType').value;
            const content = byId('msgContent').value.trim();

            const dest = `/app/meetups/${meetupId}/messages`;
            const payload = { type, content };
            stompClient.send(
                dest, { Authorization: authValue },
                JSON.stringify(payload));
            log(`Sent to ${dest}: ${JSON.stringify(payload)}`);
        }


        byId('btnConnect').addEventListener('click', connect);
        byId('btnDisconnect').addEventListener('click', disconnect);
        byId('btnSend').addEventListener('click', sendMessage);
        byId('btnLogin').addEventListener('click', login);

        // 기본값 설정
        byId('baseUrl').value = window.location.origin;
    </script>
</body>
</html>
